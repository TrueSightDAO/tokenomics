# Capital Injection Processing Implementation

**Created:** October 8, 2025  
**Script:** `capital_injection_processing.gs`  
**Location:** `google_app_scripts/tdg_asset_management/`

---

## üìã Overview

Implemented automated processing of capital injection submissions for managed AGL ledgers. The system validates digital signatures, parses Telegram submissions, and creates double-entry accounting transactions (Assets + Equity).

---

## üéØ Key Features

### 1. **Double-Entry Accounting**
Each capital injection creates TWO transactions in the target managed ledger:
- **Transaction 1 (Assets):** Increases cash/bank account
- **Transaction 2 (Equity):** Increases owner's equity/capital

### 2. **Digital Signature Validation**
- **Required:** No fallback to Telegram names
- **Validates:** Against "Contributors Digital Signatures" sheet
- **Status Check:** Must be ACTIVE

### 3. **Managed Ledgers Only**
- Only processes injections for managed AGL ledgers (AGL1, SEF1, etc.)
- Fetches ledger configurations from Wix `AgroverseShipments` collection
- Validates ledger URLs before processing

### 4. **Currency**
- Always USD (no currency column needed)
- Amount stored as positive number

---

## üìä Sheet Structure: "Capital Injection"

**Spreadsheet:** TrueSight DAO Telegram & Submissions  
**Sheet URL:** https://docs.google.com/spreadsheets/d/1qbZZhf-_7xzmDTriaJVWj6OZshyQsFkdsAV8-pyzASQ/edit#gid=1159222428  
**Header Row:** 1

| Column | Name | Type | Description |
|--------|------|------|-------------|
| A | Telegram Update ID | Number | Source Telegram update ID |
| B | Telegram Message ID | Number | Source message ID |
| C | Capital Injection Log Message | String | Full submission message |
| D | Reporter Name | String | Validated via digital signature |
| E | Ledger Name | String | Target ledger (e.g., "AGL1") |
| F | Amount | Number | Positive USD amount |
| G | Ledger URL | String | Resolved ledger URL |
| H | Injection Date | Date | YYYYMMDD format |
| I | Description | String | Injection description |
| J | Status | String | "NEW", "PROCESSED", "FAILED" |
| K | Ledger Lines Number | String | "row1,row2" (Assets, Equity) |

---

## üîÑ Processing Flow

```
1. User submits via report_capital_injection.html
   ‚Üì
2. Submission sent to Telegram ‚Üí "Telegram Chat Logs"
   ‚Üì
3. parseAndProcessCapitalInjectionLogs() detects [CAPITAL INJECTION EVENT]
   ‚Üì
4. Parse: Ledger, Amount, URL, Description, Digital Signature
   ‚Üì
5. Validate: Digital signature ‚Üí get Reporter Name
   ‚Üì
6. Insert: Record into "Capital Injection" sheet (Status: "NEW")
   ‚Üì
7. processNewCapitalInjections() finds Status="NEW" records
   ‚Üì
8. Validate: Ledger URL matches Wix managed ledgers
   ‚Üì
9. Insert: Transaction 1 (Assets) into target ledger "Transactions" sheet
   ‚Üì
10. Insert: Transaction 2 (Equity) into target ledger "Transactions" sheet
   ‚Üì
11. Update: Status="PROCESSED", Ledger Lines="row1,row2"
```

---

## üìù Submission Format

Generated by `report_capital_injection.html`:

```
[CAPITAL INJECTION EVENT]
- Ledger: AGL1
- Ledger URL: https://docs.google.com/spreadsheets/d/...
- Amount: $5000.00 USD
- Description: Initial capital for operations
- Attached Filename: invoice.pdf
- Destination Capital Injection File Location: https://github.com/...
--------

My Digital Signature: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8...

Request Transaction ID: abc123xyz...

This submission was generated using https://dapp.truesight.me/report_capital_injection.html

Verify submission here: https://dapp.truesight.me/verify_request.html
```

---

## üíæ Ledger Transaction Format

Both transactions inserted into target ledger's "Transactions" sheet:

### Transaction 1: Assets
| Column | Value |
|--------|-------|
| A (Date) | Injection Date (YYYYMMDD) |
| B (Description) | Full Capital Injection Log Message |
| C (Entity) | Reporter Name |
| D (Amount) | Positive amount |
| E (Type/Currency) | "USD" |
| F (Category) | **"Assets"** |

### Transaction 2: Equity
| Column | Value |
|--------|-------|
| A (Date) | Injection Date (YYYYMMDD) |
| B (Description) | Full Capital Injection Log Message |
| C (Entity) | Reporter Name |
| D (Amount) | Positive amount |
| E (Type/Currency) | "USD" |
| F (Category) | **"Equity"** |

---

## üîß Main Functions

### Core Processing
- `parseAndProcessCapitalInjectionLogs()` - Main entry point, parses Telegram logs
- `processNewCapitalInjections()` - Processes Status="NEW" records
- `parseCapitalInjectionMessage(message)` - Extracts details from submission
- `insertCapitalInjectionRecord(...)` - Inserts into Capital Injection sheet

### Reused from tdg_expenses_processing.gs
- `resolveRedirect(url)` - Resolves URL redirects
- `getLedgerConfigsFromWix()` - Fetches managed ledger configs
- `findContributorByDigitalSignature(digitalSignature)` - Validates reporter

### Validation
- `validateManagedLedger(ledgerUrl, ledgerConfigs)` - Verifies ledger is managed

### Test Functions
- `testParseCapitalInjectionMessage()` - Test message parsing
- `testGetLedgerConfigs()` - Test Wix ledger fetch
- `testProcessNewCapitalInjections()` - Test processing flow

---

## üß™ Testing

### Test Message Parsing
```javascript
testParseCapitalInjectionMessage()
```
Validates extraction of all fields from submission format.

### Test Ledger Configs
```javascript
testGetLedgerConfigs()
```
Fetches and displays all managed ledgers from Wix.

### Test Processing
```javascript
testProcessNewCapitalInjections()
```
Processes any Status="NEW" records in Capital Injection sheet.

---

## üîê Security

1. **Digital Signature Required:** No processing without valid ACTIVE signature
2. **Managed Ledgers Only:** Validates against Wix AgroverseShipments
3. **URL Validation:** Ensures ledger URL matches expected managed ledgers
4. **Audit Trail:** Full log message preserved in Column C and ledger transactions

---

## üìö Documentation

- **SCHEMA.md:** Complete sheet structure documented
- **Script Header:** Includes file path and repository link
- **Inline Comments:** Explains all major logic blocks
- **Test Functions:** Comprehensive testing coverage

---

## üîó Related Files

- **Frontend:** `dapp/report_capital_injection.html`
- **Backend:** `google_app_scripts/tdg_asset_management/capital_injection_processing.gs`
- **Schema:** `SCHEMA.md` (Capital Injection section)
- **Related:** `tdg_expenses_processing.gs` (similar patterns)

---

## ‚úÖ Implementation Checklist

- [x] Created `capital_injection_processing.gs`
- [x] Implemented double-entry accounting (Assets + Equity)
- [x] Digital signature validation (required, no fallback)
- [x] Managed ledger validation via Wix
- [x] Message parsing from submission format
- [x] Status tracking (NEW ‚Üí PROCESSED/FAILED)
- [x] Ledger lines tracking (comma-separated)
- [x] Test functions for all major components
- [x] Documentation in SCHEMA.md
- [x] Inline code documentation
- [x] Error handling and logging

---

**Status:** ‚úÖ Complete and ready for testing
