# Redirect all HTTP traffic to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name api.truesight.me;
    return 301 https://$host$request_uri;
}

# HTTPS endpoint for QR-code API
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.truesight.me;

    # SSL certificate and key
    ssl_certificate     /etc/ssl/certs/api.truesight.me.crt;
    ssl_certificate_key /etc/ssl/private/api.truesight.me.key;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Namespace all API calls under /v1/
    location /v1/ {
        # Proxy to Google Apps Script web app (replace SCRIPT_ID)
        proxy_pass https://script.google.com/macros/s/SCRIPT_ID/exec$is_args$args;

        # Enable SNI for upstream
        proxy_ssl_server_name on;
        proxy_ssl_name            script.google.com;

        # Preserve host and client info
        proxy_set_header Host              script.google.com;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        # Timeouts
        proxy_connect_timeout 10s;
        proxy_read_timeout    30s;
        proxy_send_timeout    10s;
    }
    # Fallback for all other paths: redirect to code documentation
    location / {
        return 302 https://github.com/TrueSightDAO/tokenomics/tree/main/google_app_scripts/agroverse_qr_code_checking;
    }
}